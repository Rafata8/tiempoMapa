<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">


<dom-module id="c-tiempo">
  <template>
    <style>

    </style>
    <paper-spinner active$="{{_loading}}"></paper-spinner>

    <iron-ajax id="buscarCiudad" method="GET" url="https://maps.googleapis.com/maps/api/geocode/json"
      params="{{params}}" handleAs="json" on-response="_geocodingResponse" on-error="mensajError">
    </iron-ajax>

    <input id="searchBox" placeholder="Search City" on-keyup="keyupInput">
    <iron-ajax id="ajaxActual" url=" https://api.openweathermap.org/data/2.5/find" params="[[myParams]]" handle-as="json"
      on-response="respactual" on-error="mensajError">
    </iron-ajax>


  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class CTiempo extends Polymer.Element {
      static get is() { return 'c-tiempo'; }
      static get properties() {
        return {
          lat: {
            type: Number,
            value: '40.405993'
          },
          lon: {
            type: Number,
            value: '-3.839583'
          },
          cnt: {
            type: Number,
            value: 20
          },
          myParams: {
            type: Object,
            computed: '_definir_params(lat,lon,cnt,units,akey)'
          },
          akey: {
            type: String,
            value: "4b2e866fd22b59e48ae153242129db3c"
          },
          tiempo_info: {
            value: function () { return [] },
            type: Array,
            notify: true
          },
          units: {
            type: String,
            value: "metric"
          },
          _loading: {
            type: Boolean,
            value: false,
            notify: true
          },
          params: {
            type: Object,
            value: function () { return {} }
          },
          api_key_geocoding: {
            type: String,
            value: "AIzaSyAJuVw4UpWvvpnUzzdeKZN5Ydsd9y_SYs8",
            reflectToAttribute: true
          }

        }

      }

      constructor() {
        super();
        this.getGeolocal();
      }

      ready() {
        super.ready()
        this.$.ajaxActual.generateRequest()
      }

      getGeolocal() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(objPosition => {
            this.lon = objPosition.coords.longitude;
            this.lat = objPosition.coords.latitude;
          })
        }
        else {
          console.log('Su navegador no soporta geolocalizacón');
        }
      }

      mensajError(e, request) {
        this.dispatchEvent(new CustomEvent('weather-request-error', { detail: { error: e } }));
      }

      respactual(event, request) {
        let apoyo = [];
        let respuesta = request.response.list;
        //console.log(respuesta);
        // this._loading = false;
        for (let i = 0; i < respuesta.length; i++) {
          apoyo.push({
            name: respuesta[i].name,
            lat: respuesta[i].coord.lat,
            lon: respuesta[i].coord.lon,
            temp: Math.floor(respuesta[i].main.temp),
            temp_max: Math.floor(respuesta[i].main.temp_max),
            temp_min: Math.floor(respuesta[i].main.temp_min),
            icon: respuesta[i].weather[0].icon,
            icono: "https://openweathermap.org/img/w/" + respuesta[i].weather[0].icon + ".png",
            description: respuesta[i].weather[0].description
          })
        }
        this.tiempo_info = apoyo;
        this._loading = false;
        this.dispatchEvent(new CustomEvent('traffic_info-ready', {}));

      }

      _definir_params(lat, lon, cnt, units, akey) {
        return { lat: lat, lon: lon, cnt: cnt, units: units, APPID: akey };
      }

      keyupInput(e) {
        if (e.keyCode === 13) {
          this.city = this.$.searchBox.value;
          this.$.searchBox.value = '';
          this.params = {};
          if (this.api_key_geocoding) {
            this.params.key = this.api_key_geocoding;
            this.params.address = this.city;
            this._loading = true;
            this.$.buscarCiudad.generateRequest();
          } else {
            console.error('Api key is required');
          }
        }


      }

      _geocodingResponse(e, res) {
        let resultado = res.response.results;
        if (resultado && resultado.length > 0) {
          //console.log(resultado)
          this.lat = resultado[0].geometry.location.lat;
          this.lon = resultado[0].geometry.location.lng;
          // this.buscar();
          this.$.ajaxActual.generateRequest()
        }
        else {
          console.log('Error Geocoding: response is empty');
          alert('Error. Prueba a poner: "Ciudad, Pais", o algo más específico.');
          this._loading = false;
          //this.fire('geocoding-request-error', { error: e });
          this.dispatchEvent(new CustomEvent('geocoding-request-error', { detail: { error: e } }));
        }

      }


      mensajError(e, request) {
        this.dispatchEvent(new CustomEvent('geocoding-request-error', { detail: { error: e } }));
      }

      // buscar() {
      //   if (this.lat2 != this.latitude || this.lon2 != this.longitude) {
      //     this._loading = true;
      //     this.lat2 = this.latitude;
      //     this.lon2 = this.longitude;
      //   }
      //   else {
      //     this.lat2 = 0;
      //     this.lon2 = 0;
      //     this.lat2 = this.latitude;
      //     this.lon2 = this.longitude;
      //   }

      // }

    }

    window.customElements.define(CTiempo.is, CTiempo);
  </script>
</dom-module>